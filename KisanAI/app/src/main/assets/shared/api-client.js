/**
 * Kisan AI Frontend Configuration
 * Auto-generated by update_config_ip.sh (Merged)
 */

window.FARMX_CONFIG = {
    // Backend server URL (Local Network)
    API_URL: "https://abraham-submissions-narrow-granny.trycloudflare.com",
    // Optional: Enable debug logging
    DEBUG: true
};

// Use configured API URL or fallback to localhost
const API_BASE_URL = (window.FARMX_CONFIG && window.FARMX_CONFIG.API_URL)
    ? window.FARMX_CONFIG.API_URL
    : "http://localhost:8000";

// Log the API URL being used
if (window.FARMX_CONFIG.DEBUG) {
    console.log("Kisan AI Config loaded:", window.FARMX_CONFIG);
}
console.log("Kisan AI API Base URL:", API_BASE_URL);

class KisanAIApi {

    static async request(endpoint, method = "GET", body = null, isFileUpload = false) {
        const url = `${API_BASE_URL}${endpoint}`;

        const headers = {};
        if (!isFileUpload) {
            headers["Content-Type"] = "application/json";
        }

        const config = {
            method,
            headers,
        };

        if (body) {
            config.body = isFileUpload ? body : JSON.stringify(body);
        }

        try {
            const response = await fetch(url, config);
            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.detail || data.error || "An error occurred");
            }
            return data;
        } catch (error) {
            console.error("API Request Error:", error);
            throw error;
        }
    }

    /* --- AUTH --- */
    static async login(mobile, password) {
        const data = await this.request("/auth/login", "POST", { mobile, password });
        return data;
    }

    static async sendOtp(mobile) {
        return await this.request("/auth/send-otp", "POST", { mobile });
    }

    static async loginWithOtp(mobile, otp) {
        return await this.request("/auth/login-with-otp", "POST", { mobile, otp });
    }

    static async register(mobile, password, username) {
        return await this.request("/auth/register", "POST", { mobile, password, username });
    }

    /* --- FEATURES --- */
    static async predictDisease(imageFile, userId) {
        const formData = new FormData();
        formData.append("file", imageFile);
        formData.append("user_id", userId);
        return await this.request("/predict", "POST", formData, true);
    }

    static async predictSoil(imageFile, userId) {
        const formData = new FormData();
        formData.append("file", imageFile);
        formData.append("user_id", userId);
        return await this.request("/predict_soil", "POST", formData, true);
    }

    static async getUserAdvice(userId, lat = null, lon = null) {
        let url = `/get_user_advice/${userId}`;
        const params = [];
        if (lat) params.push(`lat=${lat}`);
        if (lon) params.push(`lon=${lon}`);

        // Add language param
        const lang = localStorage.getItem('appLanguage') || 'en';
        params.push(`language=${lang}`);

        if (params.length > 0) {
            url += `?${params.join('&')}`;
        }
        return await this.request(url);
    }

    static async recommendFertilizer(crop, soilType) {
        return await this.request(`/recommend_fertilizer?crop=${crop}&soil_type=${soilType}`);
    }

    static async getWeather(lat, lon) {
        return await this.request(`/api/weather?lat=${lat}&lon=${lon}`);
    }
}

// User Session Management
const SessionManager = {
    setUser(user) {
        localStorage.setItem("farmx_user", JSON.stringify(user));
    },
    getUser() {
        return JSON.parse(localStorage.getItem("farmx_user"));
    },
    logout() {
        localStorage.removeItem("farmx_user");
        this.redirectToLogin();
    },
    isLoggedIn() {
        return !!this.getUser();
    },
    redirectToLogin() {
        if (window.location.protocol === 'file:') {
            const path = window.location.pathname;
            // /android_asset/index.html -> split gives ["", "android_asset", "index.html"] (length 3)
            // /android_asset/disease/index.html -> split gives ["", "android_asset", "disease", "index.html"] (length 4)
            if (path.split('/').length <= 3) {
                window.location.href = "auth/login.html";
            } else {
                window.location.href = "../auth/login.html";
            }
        } else {
            window.location.href = "/auth/login.html";
        }
    },
    requireAuth() {
        if (!this.isLoggedIn()) {
            // Avoid redirect loop if already on login page
            if (window.location.href.includes('auth/login.html')) return;
            this.redirectToLogin();
        }
    }
};
