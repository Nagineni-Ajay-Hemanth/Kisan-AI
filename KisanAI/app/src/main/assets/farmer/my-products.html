<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Products - Kisan AI</title>
    <link rel="stylesheet" href="../shared/style.css">
    <script src="../shared/api-client.js"></script>
    <style>
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .product-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .product-card h3 {
            color: var(--primary);
            margin-bottom: 8px;
        }

        .product-info {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin: 4px 0;
        }

        .product-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.85rem;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            flex: 1;
        }

        .btn-edit {
            background: #2196F3;
            color: white;
        }

        .btn-delete {
            background: #f44336;
            color: white;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }
    </style>
</head>

<body>
    <header>
        <div class="header-brand">
            <img src="../shared/assets/icon.png" alt="Kisan AI">
            <h3>My Products</h3>
        </div>
        <nav class="header-nav">
            <button class="nav-icon-btn" onclick="window.location.href='upload-product.html'">
                <span style="font-size: 24px;">+</span>
            </button>
            <button class="nav-icon-btn" onclick="window.location.href='../index.html'">
                <span style="font-size: 1.2rem;">⬅️</span>
            </button>
        </nav>
    </header>

    <div class="container">
        <div id="productsContainer" class="product-grid"></div>
        <div id="emptyState" class="empty-state" style="display: none;">
            <h3>No Products Yet</h3>
            <p>Start by uploading your first product!</p>
            <button class="btn-primary" onclick="window.location.href='upload-product.html'" style="margin-top: 20px;">
                Upload Product
            </button>
        </div>
    </div>

    <script>
        SessionManager.requireAuth();
        const user = SessionManager.getUser();

        if (user.user_type !== 'farmer') {
            window.location.href = '../customer-index.html';
        }

        async function loadProducts() {
            try {
                const data = await KisanAIApi.getFarmerProducts(user.id);

                if (data.products.length === 0) {
                    document.getElementById('emptyState').style.display = 'block';
                    return;
                }

                const container = document.getElementById('productsContainer');
                container.innerHTML = data.products.map(product => `
                    <div class="product-card">
                        ${product.image_url ? `<img src="${product.image_url}" style="width: 100%; height: 150px; object-fit: cover; border-radius: 8px; margin-bottom: 12px;">` : ''}
                        <h3>${product.name}</h3>
                        <p class="product-info"><strong>Category:</strong> ${product.category || 'N/A'}</p>
                        <p class="product-info"><strong>Price:</strong> ₹${product.price}/${product.unit}</p>
                        <p class="product-info"><strong>Available:</strong> ${product.quantity_available} ${product.unit}</p>
                        <p class="product-info"><strong>Status:</strong> ${product.status}</p>
                        ${product.description ? `<p class="product-info" style="margin-top: 8px;">${product.description}</p>` : ''}
                        <div class="product-actions">
                            <button class="btn-small btn-edit" onclick="editProduct(${product.id})">Edit</button>
                            <button class="btn-small btn-delete" onclick="deleteProduct(${product.id})">Delete</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading products:', error);
                document.getElementById('productsContainer').innerHTML = `<p style="color:red; text-align:center;">Failed to load products: ${error.message}</p>`;
            }
        }

        function editProduct(productId) {
            // For now, just show alert. Can implement edit form later
            alert('Edit functionality coming soon! Product ID: ' + productId);
        }

        async function deleteProduct(productId) {
            if (!confirm('Are you sure you want to delete this product?')) {
                return;
            }

            try {
                await KisanAIApi.deleteProduct(productId, user.id);

                alert('Product deleted successfully');
                location.reload(); // Reload to refresh list safely
            } catch (error) {
                console.error('Error deleting product:', error);
                alert('Failed to delete product: ' + error.message);
            }
        }

        // Load products on page load
        loadProducts();
    </script>
</body>

</html>