<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Product - Kisan AI</title>
    <link rel="stylesheet" href="../shared/style.css">
    <script src="../shared/api-client.js"></script>
</head>

<body>
    <header>
        <div class="header-brand">
            <img src="../shared/assets/icon.png" alt="Kisan AI">
            <h3>Upload Product</h3>
        </div>
        <nav class="header-nav">
            <button class="nav-icon-btn" onclick="window.location.href='../index.html'">
                <span style="font-size: 1.2rem;">⬅️</span>
            </button>
        </nav>
    </header>

    <div class="container">
        <div class="auth-card" style="max-width: 600px; margin: 20px auto;">
            <h2 style="color: var(--primary); margin-bottom: 20px;">Add New Product</h2>

            <form id="productForm">
                <div class="form-group">
                    <label class="form-label">Product Name *</label>
                    <input type="text" id="productName" class="form-input" placeholder="e.g., Organic Tomatoes"
                        required>
                </div>

                <div class="form-group">
                    <label class="form-label">Category *</label>
                    <select id="productCategory" class="form-input" required>
                        <option value="">Select a category</option>
                        <option value="Vegetables">Vegetables</option>
                        <option value="Fruits">Fruits</option>
                        <option value="Grains">Grains</option>
                        <option value="Dairy">Dairy</option>
                        <option value="Spices">Spices</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Price (₹) *</label>
                    <input type="number" id="productPrice" class="form-input" placeholder="e.g., 50" step="0.01"
                        min="0.01" required>
                    <small style="color: var(--text-secondary); font-size: 0.85rem;">Enter price per unit</small>
                </div>

                <div class="form-group">
                    <label class="form-label">Unit *</label>
                    <select id="productUnit" class="form-input" required>
                        <option value="kg">Kilogram (kg)</option>
                        <option value="g">Gram (g)</option>
                        <option value="piece">Piece</option>
                        <option value="dozen">Dozen</option>
                        <option value="liter">Liter</option>
                        <option value="quintal">Quintal</option>
                        <option value="ton">Ton</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Quantity Available *</label>
                    <input type="number" id="productQuantity" class="form-input" placeholder="e.g., 100" step="0.1"
                        min="0.1" required>
                    <small style="color: var(--text-secondary); font-size: 0.85rem;">How much do you have to
                        sell?</small>
                </div>

                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea id="productDescription" class="form-input" rows="3"
                        placeholder="Describe your product... (e.g., Fresh, organic, pesticide-free)"></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Image URL (optional)</label>
                    <input type="url" id="productImage" class="form-input" placeholder="https://example.com/image.jpg">
                    <small style="color: var(--text-secondary); font-size: 0.85rem;">Paste a link to your product
                        image</small>
                </div>

                <button type="submit" class="btn-primary" id="submitBtn">Upload Product</button>
                <p id="errorMsg" style="color: #d32f2f; margin-top: 15px; display: none;"></p>
                <p id="successMsg" style="color: #4CAF50; margin-top: 15px; display: none;"></p>
            </form>
        </div>
    </div>

    <script>
        SessionManager.requireAuth();
        const user = SessionManager.getUser();

        // Redirect if not farmer
        if (user.user_type !== 'farmer') {
            window.location.href = '../customer-index.html';
        }

        document.getElementById('productForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const submitBtn = document.getElementById('submitBtn');
            const errorMsg = document.getElementById('errorMsg');
            const successMsg = document.getElementById('successMsg');

            errorMsg.style.display = 'none';
            successMsg.style.display = 'none';

            const price = parseFloat(document.getElementById('productPrice').value);
            const quantity = parseFloat(document.getElementById('productQuantity').value);
            const category = document.getElementById('productCategory').value;
            const name = document.getElementById('productName').value.trim();

            // Validation
            if (!name) {
                errorMsg.textContent = "Please enter a product name.";
                errorMsg.style.display = 'block';
                return;
            }

            if (!category) {
                errorMsg.textContent = "Please select a category.";
                errorMsg.style.display = 'block';
                return;
            }

            if (isNaN(price) || price <= 0) {
                errorMsg.textContent = "Please enter a valid price greater than 0.";
                errorMsg.style.display = 'block';
                return;
            }

            if (isNaN(quantity) || quantity <= 0) {
                errorMsg.textContent = "Please enter a valid quantity greater than 0.";
                errorMsg.style.display = 'block';
                return;
            }

            const productData = {
                name: name,
                category: category,
                price: price,
                unit: document.getElementById('productUnit').value,
                quantity_available: quantity,
                description: document.getElementById('productDescription').value.trim() || "",
                image_url: document.getElementById('productImage').value.trim() || null
            };

            try {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Uploading...';

                // Use the API client wrapper which ensures config is loaded
                const response = await KisanAIApi.createProduct(productData, user.id);

                successMsg.textContent = 'Product uploaded successfully!';
                successMsg.style.display = 'block';

                // Reset form
                document.getElementById('productForm').reset();

                // Redirect after 2 seconds
                setTimeout(() => {
                    window.location.href = 'my-products.html';
                }, 2000);

            } catch (error) {
                errorMsg.textContent = error.message || 'Failed to upload product';
                errorMsg.style.display = 'block';
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Upload Product';
            }
        });
    </script>
</body>

</html>